<?php/** * Cotres model * * @package    CotRes - Cottage Reservation system * @subpackage Components * @link http://www.sigil.sk * @license */// Check to ensure this file is included in Joomla!defined('_JEXEC') or die();jimport( 'joomla.application.component.model' );jimport( 'joomla.error.error' );/** * Pricelist Model * * @package    Sigil.Cotres * @subpackage Components */class CotresModelPricelist extends JModel{	/**	 * Pricelist data array	 *	 * @var array	 */	var $_data;	/**	 * Returns the query	 * @return string The query to be used to retrieve the rows from the database	 */	function _buildQuery($y = false)	{        $y = ($y === false) ? date('Y'): $y;        $query =             "SELECT cs.*, p.price FROM "            ." (SELECT c.id as id_cottage, s.id as id_season, c.name as cottage_name, s.name as season_name, date_from, date_to, reserv_min_nights, add_fee_nights, add_fee_perc FROM "            ." #__cotres_cottages c, #__cotres_seasons s "            ." WHERE c.published > 0 AND s.published > 0 "            ." AND s.year = $y"            ." ORDER BY CONCAT(RIGHT(s.date_from,2),LEFT(s.date_from,2)), c.name "            ." ) cs "            ." LEFT JOIN #__cotres_prices p ON p.id_cottage=cs.id_cottage AND p.id_season = cs.id_season";            		return $query;	}    function getSeasonName($id)    {        $query = "SELECT * FROM #__cotres_seasons where id = $id";        $ret = $this->_getList( $query );        return $ret[0]->name;    }     function getCottageName($id)    {        $query = "SELECT * FROM #__cotres_cottages where id = $id";        $ret = $this->_getList( $query );        return $ret[0]->name;    }    	/**	 * Retrieves the cottage data	 * @return array Array of objects containing the data from the database	 */	function getData($y = false)	{		// Lets load the data if it doesn't already exist		if (empty( $this->_data ))		{			$query = $this->_buildQuery($y);			$data = $this->_getList( $query );			if (!$data)			{    			$query = $this->_buildQuery(1);    			$data = $this->_getList( $query );            }		}        $pricelist = array();        foreach ($data as $r)        {            $r->season_name = $this->getSeasonName($r->id_season); //For JoomFish compatibility            $r->cottage_name = $this->getCottageName($r->id_cottage); //For JoomFish compatibility            $pricelist[$r->id_cottage][$r->id_season] = $r;        }        //Check if first and last season have the same name and price        $first = current(current($pricelist));        $last = end(current($pricelist));        if ($first->name == $last->name && $first->price == $last->price)        { //Merge them            foreach ($pricelist as &$r)            {                end($r);                $fkey = key($r);                $tmp = reset($r);                unset($r[key($r)]);                $r[$fkey]->date_to = $tmp->date_to;                foreach ($r as &$f)                {                    $f->date_from   = str_replace("-", ".", $f->date_from);                    $f->date_to     = str_replace("-", ".", $f->date_to);                }            }        }        $this->_data = $pricelist;		return $this->_data;	}}